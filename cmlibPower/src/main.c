#include <pspkernel.h>
#include <systemctrl.h>
#include <string.h>
#include "cmlibpower.h"

/*------------------------------------------------------------*/

PSP_MODULE_INFO("cmlibPower", PSP_MODULE_KERNEL, 1, 0);

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  POWER CONTROLL
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//#define SLEEP_MODE    0(cmlibpower.h)
//#define REBOOT_MODE   1(cmlibpower.h)
//#define SHUTDOWN_MODE 2(cmlibpower.h)
//---------------------------
int powerControll(int mode)
{
	switch(mode) {
		case SLEEP_MODE:
			scePowerRequestSuspend();
			break;

		case REBOOT_MODE:
			sceKernelDcacheWritebackAll();
			sceKernelIcacheClearAll();
			sceKernelExitVSHVSH(0);
			break;

		case SHUTDOWN_MODE:
			scePowerRequestStandby();
			break;
	}
	
	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  EXE SOFT RESET
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
#define EBOOT_PATH "disc0:/PSP_GAME/SYSDIR/EBOOT.BIN"
//---------------------
void exeSoftReset(void)
{
	int k1 = pspSdkSetK1(0);
	
	u32 vshmain_args[0x0400/4];
	memset(vshmain_args, 0, 0x0400);
	vshmain_args[0/4] = 0x0400;
	vshmain_args[4/4] = 0x20;
	vshmain_args[0x40/4] = 1;
	vshmain_args[0x280/4] = 1;
	vshmain_args[0x284/4] = 0x40003;
	
	struct SceKernelLoadExecVSHParam param;
	
	memset(&param, 0, sizeof(param));
	param.size = sizeof(param);
	param.args = strlen(EBOOT_PATH)+1;
	param.argp = EBOOT_PATH;
	param.key = "game";
	param.vshmain_args_size = 0x0400;
	param.vshmain_args = vshmain_args;

	sctrlKernelLoadExecVSHWithApitype(0x120, EBOOT_PATH, &param); 

	pspSdkSetK1(k1);
	
	return;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  SET CPU INFO
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int setCpuClock(int cpuClock)
{
	
	scePowerSetCpuClockFrequency(cpuClock);
	scePowerSetBusClockFrequency(cpuClock/2);
	
	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET CPU INFO
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
CPU_INFO getCpuClock(void)
{
	CPU_INFO info;
	
	info.cpuClock = scePowerGetCpuClockFrequency();
	info.busClock = scePowerGetBusClockFrequency();
	
	return info;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET CHARGE STATUS
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int getChargeStatus(void)
{
	
	return scePowerGetBatteryChargingStatus();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET BATTERY LIFE PARCENT
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int getBatteryLifePer(void)
{
	
	return scePowerGetBatteryLifePercent();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET BATTERY LIFE TIME
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int getBatteryLifeTime(void)
{
	
	return scePowerGetBatteryLifeTime();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET BATTERY TEMP
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int getBatteryTemp(void)
{
	
	return scePowerGetBatteryTemp();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET BATTERY VOLT
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
float getBatteryVolt(void)
{
	float result = (float) scePowerGetBatteryVolt() / 1000.0;
	return result;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  IS POWER ONLINE
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int isPowerOnline(void)
{
	
	return scePowerIsPowerOnline();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  IS BATTERY EXIST
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int isBatteryExist(void)
{
	
	return scePowerIsBatteryExist();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  IS LOW BATTERY
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int isLowBattery(void)
{
	
	return scePowerIsLowBattery();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  IS BATTERY CHARGING
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int isBatteryCharging(void)
{
	
	return scePowerIsBatteryCharging();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  GET POWER INFO
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
POWER_INFO getPowerInfo(void)
{
	POWER_INFO info;
	
	info.chargeStatus	= getChargeStatus();
	info.lifePer		= getBatteryLifePer();
	info.lifeTime		= getBatteryLifeTime();

	CPU_INFO cupInfo	= getCpuClock();
	info.cpuClock		= 0;
	info.busClock		= 0;
	info.cpuClock		= cupInfo.cpuClock;
	info.busClock		= cupInfo.busClock;

	info.temp			= getBatteryTemp();
	info.volt			= getBatteryVolt();
	info.acStatus		= isPowerOnline();
	info.isExist		= isBatteryExist();
	info.isLow			= isLowBattery();
	info.isCharging		= isBatteryCharging();
	
	return info;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  ENTRY POINT
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
int module_start(SceSize args, void *argp)
{
	return 0;
}

int module_stop(SceSize args, void *argp)
{
	return 0;
}
