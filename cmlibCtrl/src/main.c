#include <pspsdk.h>
#include <pspkernel.h>
#include <pspctrl.h>
#include <pspctrl_kernel.h>

#include "cmlibctrl.h"


PSP_MODULE_INFO("cmlibCtrl", PSP_MODULE_KERNEL, 1, 0);

SceCtrlData pad;
int flag = 0;
int button = 0;
int ret = 0;

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskAllButton
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libCtrlMaskAllButton()
{
	if(flag < 0)flag = 0;
	sceCtrl_driver_7CA723DC(0xFFFF, (flag > 0 ? 1 : 0));
	
	return (flag >0 ? true : false);

}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskAllButtonOn
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libCtrlMaskAllButtonOn(bool *status)
{
	if(*status != true){
		*status = true;
		flag ++;
		libCtrlMaskAllButton();
		return 0;
	}
	return -1;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskAllButtonOff
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libCtrlMaskAllButtonOff(bool *status)
{
	if(*status == true){
		*status = false;
		flag --;
		libCtrlMaskAllButton();
		return 0;
	}
	return -1;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskAllButtonStatus
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libCtrlMaskAllButtonStatus()
{
	return (flag >0 ? true : false);

}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskAllButtonAgain
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libCtrlMaskAllButtonAgain()
{
	return libCtrlMaskAllButton();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskButtonOn
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libCtrlMaskButtonOn(int PspCtrlButtons)
{
	sceCtrl_driver_7CA723DC(PspCtrlButtons,1);
	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskButtonOff
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libCtrlMaskButtonOff(int PspCtrlButtons)
{
	sceCtrl_driver_7CA723DC(PspCtrlButtons,0);
	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlMaskButtonStatus
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libCtrlMaskButtonStatus(int PspCtrlButtons)
{
	int status = sceCtrl_driver_5E77BC8A(PspCtrlButtons);
	
	return (status == 1 ? true : false);
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libCtrlCheckButton
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libCtrlCheckButton(int PspCtrlButtons)
{
  button = PspCtrlButtons;
  while(button)sceKernelDelayThread(1000);
  int ret2 = ret;
  ret = 0;
  return ret2;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  MainThread
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int main_thread(SceSize args, void *argp)
{
//  sceCtrlSetSamplingCycle(0);
//  sceCtrlSetSamplingMode(1);
  while (1)
  {
    sceCtrlPeekBufferPositive(&pad, 1);
    if(button > 0){
        ret = (pad.Buttons & button);
        button = 0;
    }
    sceKernelDelayThread(1000);
  }
  return 0;
}


////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  ENTRY POINT
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int module_start(SceSize args, void *argp)
{
  int thid = sceKernelCreateThread("cmLibCtrl", main_thread, 32, 0x800, 0, NULL);
  if(thid >= 0)sceKernelStartThread(thid, args, argp);
  return 0;
}

int module_stop(SceSize args, void *argp)
{
  return 0;
}
